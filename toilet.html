<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ë˜¥ì—¬ì§€ë„ - Seungil Playground</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b4971d27a2f4a9ad7ca6dd6a6a071802&libraries=services"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a1a; color: #e0e6ed; }
        .container { display: flex; height: 100vh; }
        
        .sidebar {
            width: 400px;
            background: rgba(13, 27, 42, 0.98);
            border-right: 1px solid rgba(139, 69, 19, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(139, 69, 19, 0.2);
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.2), rgba(160, 82, 45, 0.1));
        }
        
        .back-link { color: #6b8bb8; text-decoration: none; font-size: 12px; }
        .title { font-size: 24px; font-weight: bold; color: #daa520; margin-top: 8px; }
        .subtitle { font-size: 11px; color: #8a9bae; margin-top: 3px; }
        
        .search-section { padding: 15px; border-bottom: 1px solid rgba(139, 69, 19, 0.2); }
        
        .search-modes { display: flex; gap: 8px; margin-bottom: 12px; }
        .mode-btn {
            flex: 1; padding: 10px; background: rgba(65, 105, 225, 0.2);
            border: 1px solid rgba(65, 105, 225, 0.3); border-radius: 8px;
            color: #8a9bae; cursor: pointer; font-size: 12px; text-align: center;
        }
        .mode-btn.active { background: rgba(218, 165, 32, 0.3); border-color: #daa520; color: #daa520; }
        
        .location-status {
            display: flex; align-items: center; gap: 8px;
            padding: 10px; background: rgba(10, 10, 26, 0.8);
            border-radius: 8px; margin-bottom: 12px; font-size: 12px;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff6b6b; }
        .status-dot.active { background: #50fa7b; }
        
        .input-group { display: flex; gap: 8px; margin-bottom: 12px; }
        .input-field {
            flex: 1; padding: 10px 12px; font-size: 13px;
            background: rgba(10, 10, 26, 0.8); border: 1px solid rgba(65, 105, 225, 0.3);
            border-radius: 8px; color: #e0e6ed; outline: none;
        }
        .input-field:focus { border-color: #daa520; }
        
        .search-btn {
            padding: 10px 16px; font-size: 14px; font-weight: bold; color: #fff;
            background: linear-gradient(135deg, #daa520, #b8860b);
            border: none; border-radius: 8px; cursor: pointer;
        }
        
        .nearby-section { display: block; }
        .address-section { display: none; }
        .address-section.active { display: block; }
        .nearby-section.hidden { display: none; }
        
        .results-section { flex: 1; overflow-y: auto; padding: 10px; }
        
        .result-card {
            background: rgba(20, 30, 50, 0.8); border: 1px solid rgba(139, 69, 19, 0.3);
            border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer;
        }
        .result-card:hover, .result-card.active { border-color: #daa520; background: rgba(30, 40, 60, 0.9); }
        
        .place-name { font-size: 14px; font-weight: bold; color: #daa520; }
        .place-num {
            display: inline-block; background: #8b4513; color: white;
            width: 18px; height: 18px; border-radius: 50%;
            text-align: center; line-height: 18px; font-size: 10px; margin-right: 6px;
        }
        .place-address { font-size: 11px; color: #8a9bae; margin-top: 4px; }
        .place-meta { display: flex; gap: 10px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
        .distance { background: rgba(80, 250, 123, 0.2); color: #50fa7b; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
        .rating-badge { 
            background: rgba(255, 215, 0, 0.2); color: #ffd700; 
            padding: 2px 8px; border-radius: 10px; font-size: 10px;
        }
        .review-count { color: #8a9bae; font-size: 10px; }
        
        .review-btn {
            margin-top: 8px; padding: 6px 12px; font-size: 11px;
            background: rgba(65, 105, 225, 0.3); border: 1px solid rgba(65, 105, 225, 0.5);
            border-radius: 6px; color: #00d4ff; cursor: pointer; width: 100%;
        }
        
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        
        .my-location-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 50px; height: 50px; background: rgba(13, 27, 42, 0.95);
            border: 2px solid rgba(218, 165, 32, 0.5); border-radius: 50%;
            cursor: pointer; font-size: 24px; z-index: 100;
        }
        
        /* Custom Info Window */
        .custom-infowindow {
            background: #1a1a3a;
            border: 1px solid rgba(218, 165, 32, 0.5);
            border-radius: 12px;
            padding: 15px;
            min-width: 220px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .info-name { font-size: 15px; font-weight: bold; color: #daa520; margin-bottom: 5px; }
        .info-address { font-size: 11px; color: #8a9bae; margin-bottom: 8px; }
        .info-meta { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .info-rating { color: #ffd700; font-size: 13px; }
        .info-count { color: #8a9bae; font-size: 11px; }
        .info-review-btn {
            width: 100%; padding: 8px; font-size: 12px; font-weight: bold;
            background: linear-gradient(135deg, #daa520, #b8860b);
            border: none; border-radius: 6px; color: white; cursor: pointer;
        }
        
        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: #1a1a3a; border: 1px solid rgba(65, 105, 225, 0.3);
            border-radius: 16px; padding: 25px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;
        }
        
        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .modal-title { font-size: 18px; color: #daa520; }
        .modal-close { background: none; border: none; color: #666; font-size: 24px; cursor: pointer; }
        .modal-place { font-size: 12px; color: #8a9bae; margin-bottom: 5px; }
        .modal-stats { display: flex; gap: 15px; margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .modal-stat { text-align: center; }
        .modal-stat-value { font-size: 20px; font-weight: bold; color: #ffd700; }
        .modal-stat-label { font-size: 10px; color: #8a9bae; }
        
        .star-rating { display: flex; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .star { font-size: 32px; cursor: pointer; color: #444; transition: all 0.2s; }
        .star:hover, .star.active { color: #ffd700; transform: scale(1.1); }
        
        .review-input {
            width: 100%; padding: 12px; font-size: 14px;
            background: rgba(10, 10, 26, 0.8); border: 1px solid rgba(65, 105, 225, 0.3);
            border-radius: 8px; color: #e0e6ed; resize: none; min-height: 80px; margin-bottom: 10px;
        }
        
        .nickname-input {
            width: 100%; padding: 10px; font-size: 13px;
            background: rgba(10, 10, 26, 0.8); border: 1px solid rgba(65, 105, 225, 0.3);
            border-radius: 8px; color: #e0e6ed; margin-bottom: 15px;
        }
        
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1; padding: 12px; font-size: 14px; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
        }
        .modal-btn.submit { background: linear-gradient(135deg, #daa520, #b8860b); color: white; }
        .modal-btn.cancel { background: rgba(100,100,100,0.3); color: #8a9bae; }
        
        .reviews-list { margin-top: 20px; border-top: 1px solid rgba(65, 105, 225, 0.2); padding-top: 15px; }
        .reviews-title { font-size: 14px; color: #daa520; margin-bottom: 10px; }
        
        .review-item {
            background: rgba(10, 10, 26, 0.5); border-radius: 8px;
            padding: 10px; margin-bottom: 8px;
        }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .review-nickname { font-size: 12px; color: #00d4ff; }
        .review-date { font-size: 10px; color: #666; }
        .review-stars { color: #ffd700; font-size: 12px; }
        .review-text { font-size: 12px; color: #aaa; margin-top: 5px; line-height: 1.4; }
        
        .no-results { text-align: center; padding: 30px; color: #6b7b8c; }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body { overflow: hidden; }
            .container {
                display: block;
                position: relative;
                height: 100vh;
                height: 100dvh;
            }
            .map-container {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 50vh !important;
                height: 50dvh !important;
                width: 100% !important;
            }
            #map {
                width: 100% !important;
                height: 100% !important;
            }
            .sidebar {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                top: auto !important;
                height: 50vh !important;
                height: 50dvh !important;
                width: 100% !important;
                border-right: none;
                border-top: 2px solid rgba(218, 165, 32, 0.5);
                overflow-y: auto;
                z-index: 10;
            }
            .sidebar-header { padding: 10px 12px; }
            .title { font-size: 18px; }
            .subtitle { font-size: 10px; }
            .search-section { padding: 8px 12px; }
            .search-modes { flex-wrap: wrap; gap: 5px; }
            .mode-btn { padding: 8px 10px; font-size: 11px; }
            .location-status { padding: 8px; font-size: 11px; }
            .input-group { gap: 5px; }
            .input-field { padding: 8px 10px; font-size: 12px; }
            .results-section { padding: 8px; max-height: 25vh; overflow-y: auto; }
            .result-card { padding: 10px; }
            .place-name { font-size: 13px; }
            .place-address { font-size: 10px; }
            
            /* ëª¨ë‹¬ ëª¨ë°”ì¼ */
            .modal { padding: 15px; margin: 10px; max-height: 85vh; }
            .modal-title { font-size: 18px; }
            .review-form { flex-direction: column; }
            .review-form input { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="back-link" onclick="if(window.parent !== window) { window.parent.showPage('home'); return false; }">â† í™ˆìœ¼ë¡œ</a>
                <h1 class="title">ğŸš½ ëŒ€ë˜¥ì—¬ì§€ë„</h1>
                <p class="subtitle">ê¸‰í•  ë• ì—¬ê¸°! í™”ì¥ì‹¤ ì°¾ê¸° + í›„ê¸°</p>
            </div>

            <div class="search-section">
                <div class="search-modes">
                    <button class="mode-btn active" data-mode="nearby">ğŸ“ ë‚´ ì£¼ë³€</button>
                    <button class="mode-btn" data-mode="address">ğŸ” ì£¼ì†Œ ê²€ìƒ‰</button>
                </div>
                
                <div class="nearby-section" id="nearbySection">
                    <div class="location-status">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="locationText">ìœ„ì¹˜ í™•ì¸ ì¤‘...</span>
                    </div>
                    <button class="search-btn" id="nearbyBtn" style="width:100%">ğŸ” ë‚´ ì£¼ë³€ í™”ì¥ì‹¤ ì°¾ê¸°</button>
                </div>
                
                <div class="address-section" id="addressSection">
                    <div class="input-group">
                        <input type="text" class="input-field" id="addressInput" placeholder="ì£¼ì†Œ ë˜ëŠ” ì¥ì†Œëª… ì…ë ¥">
                        <button class="search-btn" id="addressBtn">ğŸ”</button>
                    </div>
                </div>
            </div>

            <div class="results-section" id="results">
                <div class="no-results">
                    <p>ğŸ“ ìœ„ì¹˜ í™•ì¸ ë˜ëŠ” ì£¼ì†Œë¥¼<br>ì…ë ¥í•´ì„œ ê²€ìƒ‰í•˜ì„¸ìš”!</p>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <button class="my-location-btn" id="myLocationBtn">ğŸ“</button>

    <!-- Review Modal -->
    <div class="modal-overlay" id="reviewModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <div class="modal-title">ğŸš½ í™”ì¥ì‹¤ í›„ê¸°</div>
                    <div class="modal-place" id="modalPlaceName"></div>
                </div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            
            <div class="modal-stats" id="modalStats">
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalAvgRating">-</div>
                    <div class="modal-stat-label">í‰ê·  ë³„ì </div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalReviewCount">0</div>
                    <div class="modal-stat-label">í›„ê¸° ìˆ˜</div>
                </div>
            </div>
            
            <div class="star-rating" id="starRating">
                <span class="star" data-rating="1">â˜…</span>
                <span class="star" data-rating="2">â˜…</span>
                <span class="star" data-rating="3">â˜…</span>
                <span class="star" data-rating="4">â˜…</span>
                <span class="star" data-rating="5">â˜…</span>
            </div>
            
            <textarea class="review-input" id="reviewText" placeholder="ì²­ê²°ë„, íœ´ì§€ ìœ ë¬´, ëŒ€ê¸° ì‹œê°„ ë“±ì„ ì•Œë ¤ì£¼ì„¸ìš”!"></textarea>
            <input type="text" class="nickname-input" id="nickname" placeholder="ë‹‰ë„¤ì„ (ì„ íƒ)">
            
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn submit" onclick="submitReview()">í›„ê¸° ë“±ë¡</button>
            </div>
            
            <div class="reviews-list" id="reviewsList"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let map, ps, geocoder;
        let markers = [];
        let overlays = [];
        let places = [];
        let myLat, myLng;
        let myLocationMarker;
        let currentPlace = null;
        let selectedRating = 0;
        let placeStats = {};

        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            getMyLocation();
            setupEventListeners();
            loadStats();
        });

        function initMap() {
            map = new kakao.maps.Map(document.getElementById('map'), {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 4
            });
            ps = new kakao.maps.services.Places();
            geocoder = new kakao.maps.services.Geocoder();
        }

        function setupEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    if (this.dataset.mode === 'nearby') {
                        document.getElementById('nearbySection').classList.remove('hidden');
                        document.getElementById('addressSection').classList.remove('active');
                    } else {
                        document.getElementById('nearbySection').classList.add('hidden');
                        document.getElementById('addressSection').classList.add('active');
                    }
                });
            });

            document.getElementById('nearbyBtn').addEventListener('click', searchNearby);
            document.getElementById('addressBtn').addEventListener('click', searchByAddress);
            document.getElementById('addressInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') searchByAddress();
            });
            document.getElementById('myLocationBtn').addEventListener('click', goToMyLocation);

            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStars();
                });
            });
        }

        function updateStars() {
            document.querySelectorAll('.star').forEach(star => {
                star.classList.toggle('active', parseInt(star.dataset.rating) <= selectedRating);
            });
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                placeStats = data.stats || {};
            } catch (e) { console.log('Stats load failed'); }
        }

        function getMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        myLat = pos.coords.latitude;
                        myLng = pos.coords.longitude;
                        document.getElementById('statusDot').classList.add('active');
                        document.getElementById('locationText').textContent = 'ìœ„ì¹˜ í™•ì¸ë¨ âœ“';
                        map.setCenter(new kakao.maps.LatLng(myLat, myLng));
                        addMyLocationMarker();
                    },
                    () => {
                        document.getElementById('locationText').textContent = 'ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨ - ì£¼ì†Œ ê²€ìƒ‰ ì´ìš©';
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }

        function addMyLocationMarker() {
            if (myLocationMarker) myLocationMarker.setMap(null);
            myLocationMarker = new kakao.maps.CustomOverlay({
                position: new kakao.maps.LatLng(myLat, myLng),
                content: '<div style="background:#00d4ff;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,212,255,0.5);"></div>',
                yAnchor: 0.5, xAnchor: 0.5
            });
            myLocationMarker.setMap(map);
        }

        function searchNearby() {
            if (!myLat || !myLng) {
                alert('ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì£¼ì†Œ ê²€ìƒ‰ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            searchToilets(myLat, myLng);
        }

        function searchByAddress() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) { alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            document.getElementById('results').innerHTML = '<div class="no-results">ğŸ” ê²€ìƒ‰ ì¤‘...</div>';
            ps.keywordSearch(address, function(data, status) {
                if (status === kakao.maps.services.Status.OK && data.length > 0) {
                    map.setCenter(new kakao.maps.LatLng(data[0].y, data[0].x));
                    searchToilets(data[0].y, data[0].x);
                } else {
                    geocoder.addressSearch(address, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            map.setCenter(new kakao.maps.LatLng(result[0].y, result[0].x));
                            searchToilets(result[0].y, result[0].x);
                        } else {
                            document.getElementById('results').innerHTML = '<div class="no-results">ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢</div>';
                        }
                    });
                }
            });
        }

        function searchToilets(lat, lng) {
            document.getElementById('results').innerHTML = '<div class="no-results">ğŸ” ê²€ìƒ‰ ì¤‘...</div>';
            clearMarkers();
            places = [];
            const location = new kakao.maps.LatLng(lat, lng);
            const keywords = ['ê³µì¤‘í™”ì¥ì‹¤', 'í™”ì¥ì‹¤'];
            let completed = 0;

            keywords.forEach(keyword => {
                ps.keywordSearch(keyword, function(data, status) {
                    completed++;
                    if (status === kakao.maps.services.Status.OK) {
                        data.forEach(place => {
                            place.realDistance = getDistance(lat, lng, place.y, place.x);
                            if (place.realDistance <= 2000 && !places.find(p => p.id === place.id)) {
                                places.push(place);
                            }
                        });
                    }
                    if (completed === keywords.length) {
                        places.sort((a, b) => a.realDistance - b.realDistance);
                        places = places.slice(0, 15);
                        if (places.length > 0) {
                            displayResults(places);
                            displayMarkers(places);
                        } else {
                            document.getElementById('results').innerHTML = '<div class="no-results">ì£¼ë³€ì— í™”ì¥ì‹¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢</div>';
                        }
                    }
                }, { location, radius: 2000, size: 15 });
            });
        }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function formatDistance(m) {
            return m < 1000 ? Math.round(m) + 'm' : (m/1000).toFixed(1) + 'km';
        }

        function getStarDisplay(rating) {
            const full = Math.floor(rating);
            const half = rating % 1 >= 0.5 ? 1 : 0;
            return 'â˜…'.repeat(full) + (half ? 'Â½' : '') + 'â˜†'.repeat(5 - full - half);
        }

        function displayResults(data) {
            let html = '';
            data.forEach((place, i) => {
                const stat = placeStats[place.id] || {};
                html += `<div class="result-card" data-idx="${i}" onclick="selectPlace(${i})">
                    <div class="place-name"><span class="place-num">${i+1}</span>${place.place_name}</div>
                    <div class="place-address">ğŸ“ ${place.road_address_name || place.address_name}</div>
                    <div class="place-meta">
                        <span class="distance">ğŸš¶ ${formatDistance(place.realDistance)}</span>
                        ${stat.avgRating ? `<span class="rating-badge">â˜… ${stat.avgRating}</span>` : ''}
                        ${stat.count ? `<span class="review-count">í›„ê¸° ${stat.count}ê°œ</span>` : '<span class="review-count">í›„ê¸° ì—†ìŒ</span>'}
                    </div>
                    <button class="review-btn" onclick="event.stopPropagation(); openReviewModal(${i})">âœï¸ í›„ê¸° ë³´ê¸°/ì‘ì„±</button>
                </div>`;
            });
            document.getElementById('results').innerHTML = html;
        }

        function displayMarkers(data) {
            data.forEach((place, i) => {
                const stat = placeStats[place.id] || {};
                const position = new kakao.maps.LatLng(place.y, place.x);
                
                const marker = new kakao.maps.Marker({ map, position });
                
                // Create custom overlay for info window
                const overlayContent = document.createElement('div');
                overlayContent.className = 'custom-infowindow';
                overlayContent.innerHTML = `
                    <div class="info-name">ğŸš½ ${place.place_name}</div>
                    <div class="info-address">${place.road_address_name || place.address_name}</div>
                    <div class="info-meta">
                        ${stat.avgRating ? `<span class="info-rating">â˜… ${stat.avgRating}</span>` : '<span class="info-rating">ë³„ì  ì—†ìŒ</span>'}
                        <span class="info-count">(í›„ê¸° ${stat.count || 0}ê°œ)</span>
                    </div>
                    <button class="info-review-btn" onclick="openReviewModalById('${place.id}')">âœï¸ í›„ê¸° ë³´ê¸°/ì‘ì„±</button>
                `;
                
                const overlay = new kakao.maps.CustomOverlay({
                    content: overlayContent,
                    position: position,
                    yAnchor: 1.3,
                    xAnchor: 0.5
                });

                kakao.maps.event.addListener(marker, 'click', () => {
                    closeAllOverlays();
                    overlay.setMap(map);
                    highlightCard(i);
                    map.panTo(position);
                });

                markers.push(marker);
                overlays.push(overlay);
            });

            // Close overlay when clicking on map
            kakao.maps.event.addListener(map, 'click', closeAllOverlays);
        }

        function closeAllOverlays() {
            overlays.forEach(o => o.setMap(null));
        }

        function selectPlace(idx) {
            const place = places[idx];
            map.setCenter(new kakao.maps.LatLng(place.y, place.x));
            map.setLevel(2);
            closeAllOverlays();
            overlays[idx].setMap(map);
            highlightCard(idx);
        }

        function highlightCard(idx) {
            document.querySelectorAll('.result-card').forEach((card, i) => {
                card.classList.toggle('active', i === idx);
            });
        }

        function clearMarkers() {
            markers.forEach(m => m.setMap(null));
            overlays.forEach(o => o.setMap(null));
            markers = [];
            overlays = [];
        }

        function goToMyLocation() {
            if (myLat && myLng) {
                map.setCenter(new kakao.maps.LatLng(myLat, myLng));
                map.setLevel(4);
            } else { getMyLocation(); }
        }

        function openReviewModalById(placeId) {
            const idx = places.findIndex(p => p.id === placeId);
            if (idx !== -1) openReviewModal(idx);
        }

        async function openReviewModal(idx) {
            currentPlace = places[idx];
            selectedRating = 0;
            updateStars();
            document.getElementById('modalPlaceName').textContent = currentPlace.place_name;
            document.getElementById('reviewText').value = '';
            document.getElementById('nickname').value = '';
            document.getElementById('reviewModal').classList.add('active');
            
            try {
                const res = await fetch(`${API_BASE}/reviews?placeId=${currentPlace.id}`);
                const data = await res.json();
                const reviews = data.reviews || [];
                
                // Update modal stats
                if (reviews.length > 0) {
                    const avg = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length;
                    document.getElementById('modalAvgRating').textContent = avg.toFixed(1);
                } else {
                    document.getElementById('modalAvgRating').textContent = '-';
                }
                document.getElementById('modalReviewCount').textContent = reviews.length;
                
                displayReviews(reviews);
            } catch (e) {
                document.getElementById('modalAvgRating').textContent = '-';
                document.getElementById('modalReviewCount').textContent = '0';
                displayReviews([]);
            }
        }

        function closeModal() {
            document.getElementById('reviewModal').classList.remove('active');
            currentPlace = null;
        }

        function displayReviews(reviews) {
            const container = document.getElementById('reviewsList');
            if (reviews.length === 0) {
                container.innerHTML = '<div class="reviews-title">ğŸ“ ì²« í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
                return;
            }
            
            let html = `<div class="reviews-title">ğŸ“ í›„ê¸° ${reviews.length}ê°œ</div>`;
            reviews.forEach(r => {
                const date = new Date(r.createdAt).toLocaleDateString('ko-KR');
                html += `<div class="review-item">
                    <div class="review-header">
                        <span class="review-nickname">${r.nickname}</span>
                        <span class="review-date">${date}</span>
                    </div>
                    <div class="review-stars">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div>
                    ${r.text ? `<div class="review-text">${r.text}</div>` : ''}
                </div>`;
            });
            container.innerHTML = html;
        }

        async function submitReview() {
            if (!currentPlace) return;
            if (selectedRating === 0) { alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }

            const review = {
                placeId: currentPlace.id,
                placeName: currentPlace.place_name,
                rating: selectedRating,
                text: document.getElementById('reviewText').value.trim(),
                nickname: document.getElementById('nickname').value.trim() || 'ìµëª…'
            };

            try {
                const res = await fetch(`${API_BASE}/reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(review)
                });
                
                if (res.ok) {
                    alert('í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                    await loadStats();
                    // Refresh markers to show updated stats
                    const idx = places.indexOf(currentPlace);
                    displayResults(places);
                    // Refresh overlay content
                    if (idx !== -1) {
                        const stat = placeStats[currentPlace.id] || {};
                        const overlayContent = overlays[idx].getContent();
                        if (overlayContent && overlayContent.querySelector) {
                            overlayContent.querySelector('.info-rating').textContent = stat.avgRating ? `â˜… ${stat.avgRating}` : 'ë³„ì  ì—†ìŒ';
                            overlayContent.querySelector('.info-count').textContent = `(í›„ê¸° ${stat.count || 0}ê°œ)`;
                        }
                    }
                    openReviewModal(idx);
                } else {
                    alert('ë“±ë¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } catch (e) {
                alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
            }
        }
    </script>
</body>
</html>
