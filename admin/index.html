<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - SENGVIS Playground</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .login-box h1 { margin-bottom: 10px; color: #fff; }
        .login-box p { margin-bottom: 30px; opacity: 0.7; }
        
        .admin-container { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: rgba(255,255,255,0.05);
            border-radius: 15px; margin-bottom: 20px;
        }
        .header h1 { font-size: 1.5em; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; }
        .logout-btn {
            background: #e74c3c; color: #fff; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
        }
        
        .tabs {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .tab {
            padding: 12px 24px; background: rgba(255,255,255,0.05);
            border: none; border-radius: 10px; color: #fff;
            cursor: pointer; transition: all 0.3s;
        }
        .tab:hover, .tab.active { background: #3498db; }
        
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px; padding: 25px;
            display: none;
        }
        .panel.active { display: block; }
        .panel h2 { margin-bottom: 20px; color: #3498db; }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1); padding: 20px;
            border-radius: 12px; text-align: center;
        }
        .stat-card .value { font-size: 2em; font-weight: bold; color: #3498db; }
        .stat-card .label { opacity: 0.7; margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(255,255,255,0.05); }
        
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9em;
        }
        .btn-danger { background: #e74c3c; color: #fff; }
        .btn-primary { background: #3498db; color: #fff; }
        
        .log-entry { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace; font-size: 0.85em; }
        .log-entry .time { color: #3498db; }
        .log-entry .ip { color: #e74c3c; }
        
        .refresh-btn { margin-bottom: 15px; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <p>ìŠ¹ì¸ëœ Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            <div id="g_id_onload"
                 data-client_id="896155827665-vc7vj9t2vmb6a1uv3jmnqbp60lf4lcm7.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-size="large"
                 data-theme="filled_blue"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
            <p id="loginError" style="color: #e74c3c; margin-top: 20px; display: none;"></p>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
    <div class="admin-container" id="adminContainer">
        <div class="header">
            <h1>ğŸ“Š SENGVIS Playground ê´€ë¦¬ì</h1>
            <div class="user-info">
                <img id="userPicture" src="" alt="">
                <span id="userName"></span>
                <a class="btn btn-primary" href="/admin/project-dashboard.html" target="_blank" rel="noopener noreferrer">ğŸ“Š í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œ</a>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-panel="dashboard">ğŸ“ˆ ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" data-panel="logs">ğŸ“‹ ì ‘ì† ë¡œê·¸</button>
            <button class="tab" data-panel="posts">ğŸ“ ê²Œì‹œíŒ ê´€ë¦¬</button>
            <button class="tab" data-panel="reviews">ğŸš½ ëŒ€ë˜¥ì—¬ì§€ë„ í›„ê¸°</button>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div class="panel active" id="dashboard">
            <h2>ì„œë²„ ìƒíƒœ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value" id="statUptime">-</div>
                    <div class="label">ì„œë²„ ê°€ë™ì‹œê°„</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statCpu">-</div>
                    <div class="label">CPU ì‚¬ìš©ë¥ </div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statMemory">-</div>
                    <div class="label">ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ </div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statDisk">-</div>
                    <div class="label">ë””ìŠ¤í¬ ì‚¬ìš©ë¥ </div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statPosts">-</div>
                    <div class="label">ê²Œì‹œê¸€ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statReviews">-</div>
                    <div class="label">í›„ê¸° ìˆ˜</div>
                </div>
            </div>
            
            <!-- íŠ¸ë˜í”½ ê·¸ë˜í”„ -->
            <div style="margin-top: 30px;">
                <h2 style="margin-bottom: 15px;">ğŸ“Š ì‹¤ì‹œê°„ íŠ¸ë˜í”½</h2>
                <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px;">
                    <canvas id="trafficChart" height="200"></canvas>
                </div>
                <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="value" id="statTodayHits">-</div>
                        <div class="label">ì˜¤ëŠ˜ ì ‘ì†</div>
                    </div>
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="value" id="statHourHits">-</div>
                        <div class="label">ìµœê·¼ 1ì‹œê°„</div>
                    </div>
                    <div class="stat-card" style="flex: 1; min-width: 150px;">
                        <div class="value" id="statUniqueIps">-</div>
                        <div class="label">ê³ ìœ  IP</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary refresh-btn" onclick="loadDashboard()" style="margin-top: 20px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <!-- ì ‘ì† ë¡œê·¸ -->
        <div class="panel" id="logs">
            <h2>ìµœê·¼ ì ‘ì† ë¡œê·¸</h2>
            <button class="btn btn-primary refresh-btn" onclick="loadLogs()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <div id="logsList"></div>
        </div>

        <!-- ê²Œì‹œíŒ ê´€ë¦¬ -->
        <div class="panel" id="posts">
            <h2>ê²Œì‹œíŒ ê¸€ ëª©ë¡</h2>
            <button class="btn btn-primary refresh-btn" onclick="loadPosts()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <table>
                <thead>
                    <tr><th>ID</th><th>ì œëª©</th><th>ì‘ì„±ì</th><th>ì‘ì„±ì¼</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody id="postsList"></tbody>
            </table>
        </div>

        <!-- ëŒ€ë˜¥ì—¬ì§€ë„ í›„ê¸° -->
        <div class="panel" id="reviews">
            <h2>ëŒ€ë˜¥ì—¬ì§€ë„ í›„ê¸° ê´€ë¦¬</h2>
            <button class="btn btn-primary refresh-btn" onclick="loadReviews()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <table>
                <thead>
                    <tr><th>ì¥ì†Œ</th><th>ë³„ì </th><th>ë‚´ìš©</th><th>ì‘ì„±ì</th><th>ì‘ì„±ì¼</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody id="reviewsList"></tbody>
            </table>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminToken');
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
        if (authToken) {
            verifyToken();
        }

        function handleCredentialResponse(response) {
            fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credential: response.credential })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    showAdmin(data.user);
                } else {
                    document.getElementById('loginError').textContent = data.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
                    document.getElementById('loginError').style.display = 'block';
                }
            });
        }

        function verifyToken() {
            fetch('/api/admin/verify', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showAdmin(data.user);
                } else {
                    localStorage.removeItem('adminToken');
                    authToken = null;
                }
            });
        }

        function showAdmin(user) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userPicture').src = user.picture;
            loadDashboard();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            location.reload();
        }

        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
                
                // íŒ¨ë„ë³„ ë°ì´í„° ë¡œë“œ
                const panel = tab.dataset.panel;
                if (panel === 'dashboard') loadDashboard();
                else if (panel === 'logs') loadLogs();
                else if (panel === 'posts') loadPosts();
                else if (panel === 'reviews') loadReviews();
            });
        });

        function adminFetch(url, options = {}) {
            return fetch(url, {
                ...options,
                headers: { ...options.headers, 'Authorization': `Bearer ${authToken}` }
            }).then(r => r.json());
        }

        let trafficChart = null;
        
        function loadDashboard() {
            adminFetch('/api/admin/stats')
                .then(data => {
                    if (data.success) {
                        document.getElementById('statUptime').textContent = data.stats.uptime;
                        document.getElementById('statCpu').textContent = data.stats.cpu;
                        document.getElementById('statMemory').textContent = data.stats.memory;
                        document.getElementById('statDisk').textContent = data.stats.disk;
                        document.getElementById('statPosts').textContent = data.stats.posts;
                        document.getElementById('statReviews').textContent = data.stats.reviews;
                    }
                });
            
            // íŠ¸ë˜í”½ ë°ì´í„° ë¡œë“œ
            adminFetch('/api/admin/traffic')
                .then(data => {
                    if (data.success) {
                        document.getElementById('statTodayHits').textContent = data.todayHits;
                        document.getElementById('statHourHits').textContent = data.hourHits;
                        document.getElementById('statUniqueIps').textContent = data.uniqueIps;
                        renderTrafficChart(data.hourlyData);
                    }
                });
        }
        
        function renderTrafficChart(hourlyData) {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            
            if (trafficChart) {
                trafficChart.destroy();
            }
            
            const labels = hourlyData.map(d => d.hour + 'ì‹œ');
            const values = hourlyData.map(d => d.count);
            
            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‹œê°„ë³„ ì ‘ì†',
                        data: values,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888', stepSize: 1 }
                        }
                    }
                }
            });
        }

        function loadLogs() {
            adminFetch('/api/admin/logs')
                .then(data => {
                    if (data.success) {
                        document.getElementById('logsList').innerHTML = data.logs.map(log => `
                            <div class="log-entry">
                                <span class="time">${log.time}</span> - 
                                <span class="ip">${log.ip}</span> - 
                                ${log.method} ${log.path} - ${log.status} - ${log.userAgent}
                            </div>
                        `).join('');
                    }
                });
        }

        function loadPosts() {
            adminFetch('/api/admin/posts')
                .then(data => {
                    if (data.success) {
                        document.getElementById('postsList').innerHTML = data.posts.map(post => `
                            <tr>
                                <td>${post.id}</td>
                                <td>${escapeHtml(post.title)}</td>
                                <td>${escapeHtml(post.author)}</td>
                                <td>${new Date(post.createdAt).toLocaleString('ko-KR')}</td>
                                <td><button class="btn btn-danger" onclick="deletePost(${post.id})">ì‚­ì œ</button></td>
                            </tr>
                        `).join('');
                    }
                });
        }

        function loadReviews() {
            adminFetch('/api/admin/reviews')
                .then(data => {
                    if (data.success) {
                        document.getElementById('reviewsList').innerHTML = data.reviews.map(r => `
                            <tr>
                                <td>${escapeHtml(r.placeName || r.placeId)}</td>
                                <td>${'â­'.repeat(r.rating)}</td>
                                <td>${escapeHtml(r.text || '-')}</td>
                                <td>${escapeHtml(r.nickname)}</td>
                                <td>${new Date(r.createdAt).toLocaleString('ko-KR')}</td>
                                <td><button class="btn btn-danger" onclick="deleteReview('${r.placeId}', '${r.id}')">ì‚­ì œ</button></td>
                            </tr>
                        `).join('');
                    }
                });
        }

        function deletePost(id) {
            if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            adminFetch(`/api/admin/posts/${id}`, { method: 'DELETE' })
                .then(data => {
                    if (data.success) loadPosts();
                    else alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
                });
        }

        function deleteReview(placeId, reviewId) {
            if (!confirm('ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            adminFetch(`/api/admin/reviews/${placeId}/${reviewId}`, { method: 'DELETE' })
                .then(data => {
                    if (data.success) loadReviews();
                    else alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
