<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{TITLE}} · 자유 실험실 | 부업·AI·봇·자동화·취미</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/blog/assets/blog.css" />
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/blog/rss.xml" />
  <meta name="robots" content="index,follow" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand"><a href="/blog/">자유 실험실 | 부업·AI·봇·자동화·취미</a></div>
      <nav class="nav">
        <a href="/blog/">목록</a>
        <a href="/blog/about/">소개</a>
        <a href="/blog/privacy/">개인정보처리방침</a>
        <a href="/blog/contact/">문의</a>
      </nav>
    </div>

    <article class="post" id="post">
      <h1 id="title">-</h1>
      <div class="meta"><span id="date"></span></div>
      <div class="tags" id="tags"></div>
      <div class="prose" id="content"></div>

      <section class="extras" id="extras" style="display:none">
        <div class="navrow" id="navRow" style="display:none">
          <a class="navlink prev" id="prevLink" href="#" style="display:none">
            <span class="cap">작가의 이전글</span>
            <span class="ttl"></span>
          </a>
          <a class="navlink next" id="nextLink" href="#" style="display:none">
            <span class="cap">작가의 다음글</span>
            <span class="ttl"></span>
          </a>
        </div>

        <div class="recobox" id="recoBox" style="display:none">
          <div class="reco-title">추천 글</div>
          <div class="reco-grid" id="related"></div>
        </div>
      </section>
    </article>

    <div class="footer">© <span id="year"></span> 자유 실험실 | 부업·AI·봇·자동화·취미</div>
  </div>

  <script defer src="/blog/assets/marked.min.js"></script>
  <script defer src="/blog/assets/blog.js"></script>
  <script>
    // wait for deferred scripts (marked/blog.js) and DOM
    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('year').textContent = new Date().getFullYear();

      const waitFor = (fn, timeoutMs=5000) => new Promise((resolve, reject)=>{
        const started = Date.now();
        (function tick(){
          try{ if(fn()) return resolve(true) }catch(e){}
          if(Date.now()-started > timeoutMs) return reject(new Error('timeout'))
          setTimeout(tick, 30)
        })()
      })

      ;(async ()=>{
        const slug = '{{SLUG}}';
        const res = await fetch(`/blog/posts/${slug}.md`);
      if(!res.ok){ document.getElementById('post').innerHTML = '<div class="notice">글을 불러오지 못했습니다.</div>'; return; }
      const md = await res.text();

      // frontmatter parse (same logic)
      function parseFrontmatter(md){
        if(!md.startsWith('---')) return {meta:{}, body: md}
        const end = md.indexOf('\n---', 3)
        if(end === -1) return {meta:{}, body: md}
        const fm = md.slice(3, end).trim()
        const body = md.slice(end + 4).trimStart()
        const meta = {}
        fm.split('\n').forEach(line=>{
          const idx=line.indexOf(':')
          if(idx===-1) return
          const k=line.slice(0,idx).trim()
          const v=line.slice(idx+1).trim()
          if(v.startsWith('[') && v.endsWith(']')) meta[k]=v.slice(1,-1).split(',').map(s=>s.trim()).filter(Boolean)
          else meta[k]=v
        })
        return {meta, body}
      }
      function fmtDate(iso){
        try{ return new Date(iso).toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'}) }catch{ return iso }
      }
      function normalizeTags(tags){
        if(!tags) return []
        if(Array.isArray(tags)) return tags
        return String(tags).split(',').map(s=>s.trim()).filter(Boolean)
      }

      const {meta, body} = parseFrontmatter(md);
      const title = meta.title || slug;
      const date = meta.date ? fmtDate(meta.date) : '';
      const tags = normalizeTags(meta.tags);

      document.getElementById('title').textContent = title;
      document.getElementById('date').textContent = date;
      document.title = `${title} · 자유 실험실 | 부업·AI·봇·자동화·취미`;
      document.getElementById('tags').innerHTML = tags.map(t=>`<a class="tag" href="/blog/?tag=${encodeURIComponent(t)}">#${t}</a>`).join('');

      await waitFor(()=>window.marked && typeof window.marked.parse === 'function');
      document.getElementById('content').innerHTML = window.marked.parse(body, {mangle:false, headerIds:false});

      // performance: lazy-load images
      document.querySelectorAll('#content img').forEach(img=>{ img.loading = 'lazy'; img.decoding = 'async' });

      // Prev/Next + Related
      try{
        const idxRes = await fetch('/blog/posts/index.json');
        if(idxRes.ok){
          const data = await idxRes.json();
          const posts = data.posts || [];
          const i = posts.findIndex(p=>String(p.slug)===String(slug));

          // newest-first index
          const newer = i>0 ? posts[i-1] : null;
          const older = (i>=0 && i<posts.length-1) ? posts[i+1] : null;

          const extras = document.getElementById('extras');
          const navRow = document.getElementById('navRow');
          const prevA = document.getElementById('prevLink');
          const nextA = document.getElementById('nextLink');

          if(newer){
            nextA.style.display='';
            nextA.href = `/blog/${encodeURIComponent(String(newer.id))}/`;
            nextA.querySelector('.ttl').textContent = newer.title;
          }
          if(older){
            prevA.style.display='';
            prevA.href = `/blog/${encodeURIComponent(String(older.id))}/`;
            prevA.querySelector('.ttl').textContent = older.title;
          }
          if(newer || older){
            extras.style.display='';
            navRow.style.display='';
          }

          // related below

          const rel = document.getElementById('related');
          if(tags.length){
            const tagSet = new Set(tags.map(t=>String(t).toLowerCase()));
            const related = posts
              .filter(p=>String(p.slug)!==String(slug))
              .map(p=>({
                p,
                score: normalizeTags(p.tags).reduce((acc,t)=>acc + (tagSet.has(String(t).toLowerCase()) ? 1 : 0), 0)
              }))
              .filter(x=>x.score>0)
              .sort((a,b)=>b.score-a.score)
              .slice(0, 6)
              .map(x=>x.p);
            if(related.length){
              rel.style.display='';
              rel.innerHTML = `
                <h3>관련 글</h3>
                <ul>
                  ${related.map(p=>`<li><a href="/blog/${encodeURIComponent(String(p.id))}/">${p.title}</a></li>`).join('')}
                </ul>
              `;
            }
          }
        }
      }catch(e){ /* ignore */ }
    })().catch(err=>{
      console.error(err);
      document.getElementById('content').innerHTML = '<div class="notice">글 렌더링 중 오류가 발생했습니다.</div>'
    });
  });
  </script>
</body>
</html>
